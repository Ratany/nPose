// The nPose scripts are licensed under the GPLv2
// (http://www.gnu.org/licenses/gpl-2.0.txt), with the following
// addendum:
//
// The nPose scripts are free to be copied, modified, and
// redistributed, subject to the following conditions:
//
//    - If you distribute the nPose scripts, you must leave them full
//      perms.
//
//    - If you modify the nPose scripts and distribute the
//      modifications, you must also make your modifications full
//      perms.
//
// "Full perms" means having the modify, copy, and transfer
// permissions enabled in Second Life and/or other virtual world
// platforms derived from Second Life (such as OpenSim).  If the
// platform should allow more fine-grained permissions, then "full
// perms" will mean the most permissive possible set of permissions
// allowed by the platform.
// =repo-npose/core.o
// compiled Fri Jan 31 06:37:38 2014 UTC
integer vAA;integer vAB;integer vAC;integer vAD=0;integer vAE=0;integer vAF;integer vAX;integer vAH=0;key vAI;key vAJ;key vAK;key vAL;string vAM;string vAN;list vAO;integer vAP(key vAQ){integer vAR;{integer $_=llGetNumberOfPrims();vAR=$_;while($_&&!(vAR=!(llGetLinkKey($_)!=vAQ))&&(ZERO_VECTOR!=llGetAgentSize(llGetLinkKey($_)))){--$_;}}return vAR;}SwapTwoSlots(integer vAS,integer vAT){if(vAT<=vAH){integer vAU=llListFindList(vAO,["seat"+(string)vAS])/8;integer vAV=llListFindList(vAO,["seat"+(string)vAT])/8;list vAW=llList2List(vAO,vAV*8,vAV*8+3)+[llList2Key(vAO,4+8*(vAU))]+llList2List(vAO,vAV*8+5,vAV*8+7);vAO=llListReplaceList(vAO,llList2List(vAO,vAU*8,vAU*8+3)+[llList2Key(vAO,4+8*(vAV))]+llList2List(vAO,vAU*8+5,vAU*8+7),vAU*8,(vAU+1)*8-1);vAO=llListReplaceList(vAO,vAW,vAV*8,(vAV+1)*8-1);}else{llRegionSayTo(llList2Key(vAO,llListFindList(vAO,["seat"+(string)vAS])-4),0,"Seat "+(string)vAT+" is not available for this pose set");}llMessageLinked(LINK_SET,35353,llDumpList2String(vAO,"^"),NULL_KEY);}ProcessLine(string vAX,key vAY){vAX=llStringTrim(vAX,STRING_TRIM);list vCL=llParseString2List(vAX,["|"],[]);string vBA=llList2String(vCL,0);if("ANIM"==vBA){if(vAH<vAF){vAO=llListReplaceList(vAO,[llList2String(vCL,1),((vector)llList2String(vCL,2)),llEuler2Rot((((vector)llList2String(vCL,3)))*DEG_TO_RAD),llList2Key(vCL,4),llList2String(vAO,(vAH)*8+4),"","","seat"+(string)(vAH+1)],vAH*8,vAH*8+7);}else{vAO+=[llList2String(vCL,1),((vector)llList2String(vCL,2)),llEuler2Rot((((vector)llList2String(vCL,3)))*DEG_TO_RAD),llList2String(vCL,4),"","","","seat"+(string)(vAH+1)];}vAH++;return;}if("SINGLE"==vBA){integer vBB=llListFindList(vAO,[((vector)llList2String(vCL,2))]);if((vBB==-1)||((vBB!=-1)&&llList2String(vAO,vBB-1)!=llList2String(vCL,1))){integer vBC=llListFindList(vAO,[vAJ])-4;vAO=llListReplaceList(vAO,[llList2String(vCL,1),((vector)llList2String(vCL,2)),llEuler2Rot((((vector)llList2String(vCL,3)))*DEG_TO_RAD),llList2String(vCL,4),llList2Key(vAO,vBC+4),"","",llList2String(vAO,vBC+7)],vBC,vBC+7);integer vBD=(vBC+7+8-7)/8;if(vBD>vAH){llOwnerSay(llDumpList2String(["(",(61440-llGetUsedMemory())>>10,"kB ) ~>","slot gap:",vBD-vAH,"slots","{","src/core.lsl",":",317,"}"]," "));vAH=vBD;vAF=vAH;}}return;}if("PROP"==vBA){string vBE=llList2String(vCL,1);if(llGetInventoryType(vBE)==INVENTORY_OBJECT){list vBF=llParseString2List(llList2String(vCL,2),["="],[]);if(llList2String(vBF,1)=="die"){llRegionSay(vAC,llList2String(vBF,0)+"=die");}else{integer vBG=(llList2String(vCL,4)=="explicit");(vAA+=2*(!(vAA&2))*!!(vBG)-2*(!!(vAA&2))*!(vBG));vector vBH=((vector)llList2String(vCL,2));vector vBI=llGetPos()+(vBH*llGetRot());rotation vBJ=llEuler2Rot((((vector)llList2String(vCL,3)))*DEG_TO_RAD)*llGetRot();if(llVecMag(vBH)>9.9){llRezAtRoot(vBE,llGetPos(),ZERO_VECTOR,vBJ,vAC);llSleep(1.0);llRegionSay(vAC,llDumpList2String(["MOVEPROP",vBE,(string)vBI],"|"));}else{llRezAtRoot(vBE,llGetPos()+(((vector)llList2String(vCL,2))*llGetRot()),ZERO_VECTOR,vBJ,vAC);}}}return;}if("LINKMSG"==vBA){integer vBU=llList2Integer(vCL,1);string vBL=llDumpList2String(llParseStringKeepNulls(vAX,["%AVKEY%"],[]),vAY);list vBM=llParseString2List(vBL,["|"],[]);key vBN=llList2Key(vBM,3);if(vBN==""){vBN=llList2Key(vAO,4+8*(vAH-1));}string vBV=llList2String(vBM,2);llMessageLinked(LINK_SET,vBU,vBV,vBN);llSleep(1.0);llRegionSay(vAC,llDumpList2String(["LINKMSGQUE",vBU,vBV,vBN],"|"));return;}if("SATMSG"==vBA){integer vBQ=(vAH-1)*8+5;vAO=llListReplaceList(vAO,[llDumpList2String([llList2String(vAO,vBQ),llDumpList2String(llDeleteSubList(vCL,0,0),"|")],"§")],vBQ,vBQ);return;}if("NOTSATMSG"==vBA){integer vBQ=(vAH-1)*8+6;vAO=llListReplaceList(vAO,[llDumpList2String([llList2String(vAO,vBQ),llDumpList2String(llDeleteSubList(vCL,0,0),"|")],"§")],vBQ,vBQ);}}default{state_entry(){llOwnerSay("("+(string)((61440-llGetUsedMemory())>>10)+"kB) ~> repo-npose-b4470b48647ccbac8389daddf5a4863867e8d218 2014-01-31 07:37:38");integer vCX=llGetObjectPrimCount(llGetKey());if(!(vCX)){llLinkSitTarget(vCX,<0.0,0.0,0.5>,ZERO_ROTATION);}while(vCX){llLinkSitTarget(vCX,<0.0,0.0,0.5>,ZERO_ROTATION);--vCX;}vAC=(integer)("0x"+llGetSubString((string)llGetKey(),0,7));llMessageLinked(LINK_SET,1,(string)vAC,NULL_KEY);vAD=llGetNumberOfPrims();vAE=vAD;llListen(vAC,"",NULL_KEY,"");vAN="";integer vBS=llGetInventoryNumber(INVENTORY_NOTECARD);while(vCX<vBS){vAN=llGetInventoryName(INVENTORY_NOTECARD,vCX);if(!(llSubStringIndex(vAN,"DEFAULT:")&&llSubStringIndex(vAN,"SET:"))){llMessageLinked(LINK_SET,200,vAN,NULL_KEY);return;}++vCX;}}link_message(integer vBT,integer vBU,string vBV,key vCO){if(vBU==999999){llResetScript();}if(vBU==200){vAN=vBV;vAJ=vCO;vAF=vAH;vAH=0;llRegionSay(vAC,"die");llRegionSay(vAC,"adjuster_die");vAX=0;if(llGetInventoryKey(vAN)){vAK=llGetNotecardLine(vAN,vAX);}return;}if(vBU==207){vAM=vBV;vAJ=vCO;vAB=0;vAI=llGetNotecardLine(vAM,vAB);return;}if(vBU==201){(vAA+=1*!(vAA&1));return;}if(vBU==205){(vAA-=1*(!!(vAA&1)));return;}if(vBU==300){list vCK=llParseString2List(vBV,["|"],[]);if(vCO!=NULL_KEY){vCK=llListReplaceList(vCK,[vCO],2,2);}llRegionSay(vAC,llDumpList2String(["LINKMSG"]+llList2List(vCK,0,2),"|"));return;}if(vBU==202){if(llGetListLength(vAO)/8>=2){list vBY=llParseString2List(vBV,[","],[]);SwapTwoSlots(llList2Integer(vBY,0),llList2Integer(vBY,1));}return;}if(vBU==210){{integer vBZ=(integer)llGetSubString(llList2String(vAO,llListFindList(vAO,[vCO])+3),4,-1);if(vBZ<=0){llWhisper(0,"avatar is not assigned a slot: "+(string)vCO);}else{SwapTwoSlots(vBZ,(integer)vBV);}}return;}if(vBU==(2035353)){list vCA=llParseStringKeepNulls(vBV,["^"],[]);integer vCB=llGetListLength(vCA)/8;integer vCY;for(vCY=0;vCY<vCB;++vCY){vAO=llListReplaceList(vAO,[llList2String(vCA,vCY*8),((vector)llList2String(vCA,vCY*8+1)),((rotation)llList2String(vCA,vCY*8+2)),llList2String(vCA,vCY*8+3),llList2Key(vCA,vCY*8+4),llList2String(vCA,vCY*8+5),llList2String(vCA,vCY*8+6),llList2String(vCA,vCY*8+7)],vCY*8,vCY*8+7);}return;}if(vBU==-999&&vBV=="RezHud"){if(llGetInventoryType("npose admin hud")!=INVENTORY_NONE){llRezObject("npose admin hud",llGetPos()+<0,0,1>,ZERO_VECTOR,llGetRot(),vAC);}return;}if(vBU==-999&&vBV=="RemoveHud"){llRegionSayTo(vAL,vAC,"/die");return;}if(vBU==34334){llSay(0,"Memory Used by "+llGetScriptName()+": "+(string)llGetUsedMemory()+" of "+(string)llGetMemoryLimit()+", Leaving "+(string)llGetFreeMemory()+" memory free.");return;}}object_rez(key vCO){if(llKey2Name(vCO)=="npose admin hud"){vAL=vCO;llSleep(2.0);llRegionSayTo(vAL,vAC,"parent|"+(string)llGetKey());}}listen(integer vCE,string vCF,key vCO,string vCH){list vCI=llParseString2List(vCH,["|"],[]);if(vCF=="Adjuster"){llMessageLinked(LINK_SET,3,vCH,vCO);return;}if(!(llGetListLength(vCI)<2)){if(vCF==llKey2Name(vAL)){list vCJ=["adjust",201,"stopadjust",205,"posdump",204,"hudsync",206];integer $_=llListFindList(vCJ,[vCH]);if(~$_){llMessageLinked(LINK_SET,llList2Integer(vCJ,$_+1),"","");}}return;}integer $_0=(llGetSubString(vCH,0,4)=="ping");integer $_1=(llGetSubString(vCH,0,8)=="PROPRELAY");if(($_0||$_1)&&(llGetOwnerKey(vCO)==llGetOwner())){if($_0){llRegionSay(vAC,"pong|"+(string)(!!(vAA&2))+"|"+(string)llGetPos());return;}if($_1){list vCK=llParseString2List(vCH,["|"],[]);llMessageLinked(LINK_SET,llList2Integer(vCK,1),llList2String(vCK,2),llList2Key(vCK,3));return;}list vCL=llParseString2List(vCH,["|"],[]);vector vCM=((vector)llList2String(vCL,0))-llGetPos();vCM/=llGetRot();rotation vCN=((rotation)llList2String(vCL,1))/llGetRot();string $_="\nPROP|"+vCF+"|"+(string)vCM+"|"+(string)(llRot2Euler(vCN)*RAD_TO_DEG)+"|"+llList2String(vCL,2);llRegionSayTo(llGetOwner(),0,$_);llMessageLinked(LINK_SET,34333,$_,NULL_KEY);}}dataserver(key vCO,string vCP){if(vCO==vAK){if(!(EOF==vCP)){ProcessLine(vCP,vAJ);vAX++;vAK=llGetNotecardLine(vAN,vAX);return;}if(vAH<vAF){integer vCQ;vCQ=0;while((vCQ<vAH)&&(llList2String(vAO,vCQ*8+4)!="")){++vCQ;}vCQ=vCQ*((vCQ!=vAH)-(vCQ==vAH))-!vAH;integer vCR=vAH;while(vCR<=vAF){key vCS=llList2Key(vAO,4+8*(vCR));if(vCS){if(!(vCQ<0)){if(vAP((key)vCS)){llMessageLinked(LINK_SET,-222,vCS,NULL_KEY);}}else{vAO=llListReplaceList(vAO,[llList2Key(vAO,vCR*8+4)],vCQ*8+4,vCQ*8+4);vCQ=0;while((vCQ<vAH)&&(llList2String(vAO,vCQ*8+4)!="")){++vCQ;}vCQ=vCQ*((vCQ!=vAH)-(vCQ==vAH))-!vAH;}}++vCR;}vAO=llDeleteSubList(vAO,vAH*8,-1);vAF=vAH;}llMessageLinked(LINK_SET,35353,llDumpList2String(vAO,"^"),NULL_KEY);if((!!(vAA&1))){llMessageLinked(LINK_SET,2,"RezAdjuster","");}return;}if((vCO==vAI)&&(vCP!=EOF)){ProcessLine(vCP,vAJ);vAB++;vAI=llGetNotecardLine(vAM,vAB);}}changed(integer vCT){if(vCT&CHANGED_LINK){llMessageLinked(LINK_SET,1,(string)vAC,NULL_KEY);vAE=vAD;vAD=llGetNumberOfPrims();key vCU=llGetLinkKey(llGetNumberOfPrims());if((vAD<vAE)||!(ZERO_VECTOR!=llGetAgentSize(vCU))){integer vCX=llGetListLength(vAO)/8;while(vCX){--vCX;if(!vAP(llList2Key(vAO,4+8*(vCX)))){vAO=llListReplaceList(vAO,[""],vCX*8+4,vCX*8+4);}}vAE=vAD;llMessageLinked(LINK_SET,35353,llDumpList2String(vAO,"^"),NULL_KEY);return;}if(vAD>vAE){if((!~llListFindList(vAO,[vCU]))){integer vCW=llGetObjectPrimCount(llGetKey());integer vCX=1;while(vCX<=vCW){integer vCY=(integer)llGetLinkName(vCX);if((vCY>0)&&(vCY<=vAH)){if(llAvatarOnLinkSitTarget(vCX)==vCU){if(llList2Key(vAO,4+8*(vCY-1))==""){vAO=llListReplaceList(vAO,[vCU],(vCY-1)*8+4,(vCY-1)*8+4);}}}++vCX;}}if((!~llListFindList(vAO,[vCU]))){integer vCZ;vCZ=0;while((vCZ<vAH)&&(llList2String(vAO,vCZ*8+4)!="")){++vCZ;}vCZ=vCZ*((vCZ!=vAH)-(vCZ==vAH))-!vAH;if(vCZ>=0){vAO=llListReplaceList(vAO,[vCU],vCZ*8+4,vCZ*8+4);}else{if(vAP(vCU)){llMessageLinked(LINK_SET,-222,(string)vCU,NULL_KEY);}}}llMessageLinked(LINK_SET,35353,llDumpList2String(vAO,"^"),NULL_KEY);}}if(vCT&CHANGED_INVENTORY){llResetScript();}if(vCT&CHANGED_REGION){llMessageLinked(LINK_SET,35353,llDumpList2String(vAO,"^"),NULL_KEY);}}on_rez(integer vDA){llResetScript();}}
