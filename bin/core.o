// The nPose scripts are licensed under the GPLv2
// (http://www.gnu.org/licenses/gpl-2.0.txt), with the following
// addendum:
//
// The nPose scripts are free to be copied, modified, and
// redistributed, subject to the following conditions:
//
//    - If you distribute the nPose scripts, you must leave them full
//      perms.
//
//    - If you modify the nPose scripts and distribute the
//      modifications, you must also make your modifications full
//      perms.
//
// "Full perms" means having the modify, copy, and transfer
// permissions enabled in Second Life and/or other virtual world
// platforms derived from Second Life (such as OpenSim).  If the
// platform should allow more fine-grained permissions, then "full
// perms" will mean the most permissive possible set of permissions
// allowed by the platform.
// =repo-npose/core.o
// compiled Wed Jan 29 12:44:50 2014 UTC
integer vAA=0;list vAB;integer vAC=0;integer vAD=0;integer vAE;integer vAF;integer vBK;key vAH;key vAI;integer vAJ;string vAK;integer vAL;key vAM;string vAN;list vAO;key vAP;integer vAQ=0;integer vAR(key vAS){integer vAT;{integer $_=llGetNumberOfPrims();vAT=$_;while($_&&!(vAT=!(llGetLinkKey($_)!=vAS))&&(ZERO_VECTOR!=llGetAgentSize(llGetLinkKey($_)))){--$_;}}return vAT;}assignSlots(){if(vAA<vAE){integer vBB=vAA;while(vBB<=vAE){if(llList2Key(vAB,vBB*8+4)!=""){integer vAV=0;while((vAV<vAA)&&(llList2String(vAB,vAV*8+4)!="")){++vAV;}vAV=vAV*((vAV!=vAA)-(vAV==vAA))-!vAA;if(vAV>=0){vAB=llListReplaceList(vAB,[llList2Key(vAB,vBB*8+4)],vAV*8+4,vAV*8+4);}}++vBB;}vAB=llDeleteSubList(vAB,vAA*8,-1);integer vCC=llGetListLength(vAB)/8;while(vCC){--vCC;if(!vAR(llList2Key(vAB,4+8*(vCC)))){llMessageLinked(LINK_SET,-222,(string)llList2Key(vAB,4+8*(vCC)),NULL_KEY);}}}key vAX=llGetLinkKey(llGetNumberOfPrims());if((vAC>vAD)&&(ZERO_VECTOR!=llGetAgentSize(vAX))){integer vAY=llGetObjectPrimCount(llGetKey());integer vCN=-1;integer vCC=1;while(vCC<=vAY){integer vBB=(integer)llGetLinkName(vCC);if((vBB>0)&&(vBB<=vAA)){if(llAvatarOnLinkSitTarget(vCC)==vAX){if(llList2String(vAB,(vBB-1)*8+4)==""){vCN=vBB;}}}++vCC;}for(vCC=1;vCC<=vAY;++vCC){if(~vCN&&(!~llListFindList(vAB,[vAX]))){if(vCN<=vAA){vAB=llListReplaceList(vAB,[vAX],(vCN-1)*8+4,(vCN-1)*8+4);}else{llOwnerSay(llDumpList2String(["(",(61440-llGetUsedMemory())>>10,"kB ) ~>","irregular slot","{","src/core.lsl",":",325,"}"]," "));integer vBD=0;while((vBD<vAA)&&(llList2String(vAB,vBD*8+4)!="")){++vBD;}vBD=vBD*((vBD!=vAA)-(vBD==vAA))-!vAA;if(vBD>=0){vAB=llListReplaceList(vAB,[vAX],vBD*8+4,vBD*8+4);}else{if(vAR(vAX)){llMessageLinked(LINK_SET,-222,(string)vAX,NULL_KEY);}}}vCC=vAY<<1;}if((!~llListFindList(vAB,[vAX]))){integer vBD=0;while((vBD<vAA)&&(llList2String(vAB,vBD*8+4)!="")){++vBD;}vBD=vBD*((vBD!=vAA)-(vBD==vAA))-!vAA;if(vBD>=0){vAB=llListReplaceList(vAB,[vAX],vBD*8+4,vBD*8+4);}else{if(vAR(vAX)){llMessageLinked(LINK_SET,-222,(string)vAX,NULL_KEY);}}vCC=vAY<<1;}}}else{if(vAC<vAD){integer vCC=llGetListLength(vAB)/8;while(vCC){--vCC;if(!vAR(llList2Key(vAB,4+8*(vCC)))){vAB=llListReplaceList(vAB,[""],vCC*8+4,vCC*8+4);}}}}vAD=vAC;vAE=vAA;llMessageLinked(LINK_SET,35353,llDumpList2String(vAB,"^"),NULL_KEY);}SwapTwoSlots(integer vBF,integer vBG){if(vBG<=vAA){integer vBH=llListFindList(vAB,["seat"+(string)vBF])/8;integer vBI=llListFindList(vAB,["seat"+(string)vBG])/8;list vBJ=llList2List(vAB,vBI*8,vBI*8+3)+[llList2Key(vAB,vBH*8+4)]+llList2List(vAB,vBI*8+5,vBI*8+7);vAB=llListReplaceList(vAB,llList2List(vAB,vBH*8,vBH*8+3)+[llList2Key(vAB,vBI*8+4)]+llList2List(vAB,vBH*8+5,vBH*8+7),vBH*8,(vBH+1)*8-1);vAB=llListReplaceList(vAB,vBJ,vBI*8,(vBI+1)*8-1);}else{llRegionSayTo(llList2Key(vAB,llListFindList(vAB,["seat"+(string)vBF])-4),0,"Seat "+(string)vBG+" is not available for this pose set");}llMessageLinked(LINK_SET,35353,llDumpList2String(vAB,"^"),NULL_KEY);}ProcessLine(string vBK,key vBL){vBK=llStringTrim(vBK,STRING_TRIM);list vCW=llParseString2List(vBK,["|"],[]);string vBN=llList2String(vCW,0);if("ANIM"==vBN){if(vAA<vAE){vAB=llListReplaceList(vAB,[llList2String(vCW,1),llList2Vector(vCW,2),llEuler2Rot((llList2Vector(vCW,3))*DEG_TO_RAD),llList2Key(vCW,4),llList2String(vAB,(vAA)*8+4),"","","seat"+(string)(vAA+1)],vAA*8,vAA*8+7);}else{vAB+=[llList2String(vCW,1),llList2Vector(vCW,2),llEuler2Rot((llList2Vector(vCW,3))*DEG_TO_RAD),llList2String(vCW,4),"","","","seat"+(string)(vAA+1)];}vAA++;return;}if("SINGLE"==vBN){integer vBO=llListFindList(vAB,[(vector)llList2String(vCW,2)]);if((vBO==-1)||((vBO!=-1)&&llList2String(vAB,vBO-1)!=llList2String(vCW,1))){integer vBP=llListFindList(vAB,[vAI])-4;vAB=llListReplaceList(vAB,[llList2String(vCW,1),(vector)llList2String(vCW,2),llEuler2Rot((llList2Vector(vCW,3))*DEG_TO_RAD),llList2String(vCW,4),llList2Key(vAB,vBP+4),"","",llList2String(vAB,vBP+7)],vBP,vBP+7);}vAA=llGetListLength(vAB)/8;vAE=vAA;return;}if("PROP"==vBN){string vBQ=llList2String(vCW,1);if(llGetInventoryType(vBQ)==INVENTORY_OBJECT){list vBR=llParseString2List(llList2String(vCW,2),["="],[]);if(llList2String(vBR,1)=="die"){llRegionSay(vAJ,llList2String(vBR,0)+"=die");}else{if(llList2String(vCW,4)=="explicit"){vAQ=1;}else{vAQ=0;}vector vBS=(vector)llList2String(vCW,2);vector vBT=llGetPos()+(vBS*llGetRot());rotation vBU=llEuler2Rot((llList2Vector(vCW,3))*DEG_TO_RAD)*llGetRot();if(llVecMag(vBS)>9.9){llRezAtRoot(vBQ,llGetPos(),ZERO_VECTOR,vBU,vAJ);llSleep(1.0);llRegionSay(vAJ,llDumpList2String(["MOVEPROP",vBQ,(string)vBT],"|"));}else{llRezAtRoot(vBQ,llGetPos()+((vector)llList2String(vCW,2)*llGetRot()),ZERO_VECTOR,vBU,vAJ);}}}return;}if("LINKMSG"==vBN){integer vCF=(integer)llList2String(vCW,1);string vBW=llDumpList2String(llParseStringKeepNulls(vBK,["%AVKEY%"],[]),vBL);list vBX=llParseString2List(vBW,["|"],[]);key vBY;if((key)llList2String(vBX,3)!=""){vBY=(key)llList2String(vBX,3);}else{vBY=(key)llList2String(vAB,(vAA-1)*8+4);}string vCG=llList2String(vBX,2);llMessageLinked(LINK_SET,vCF,vCG,vBY);llSleep(1.0);llRegionSay(vAJ,llDumpList2String(["LINKMSGQUE",vCF,vCG,vBY],"|"));return;}if("SATMSG"==vBN){integer vCB=(vAA-1)*8+5;vAB=llListReplaceList(vAB,[llDumpList2String([llList2String(vAB,vCB),llDumpList2String(llDeleteSubList(vCW,0,0),"|")],"§")],vCB,vCB);return;}if("NOTSATMSG"==vBN){integer vCB=(vAA-1)*8+6;vAB=llListReplaceList(vAB,[llDumpList2String([llList2String(vAB,vCB),llDumpList2String(llDeleteSubList(vCW,0,0),"|")],"§")],vCB,vCB);}}default{state_entry(){llOwnerSay("("+(string)((61440-llGetUsedMemory())>>10)+"kB) ~> repo-npose-6db4a847178f5ec21219eb3c687aa6af14ca7bc7");integer vCC=llGetObjectPrimCount(llGetKey());if(!(vCC)){llLinkSitTarget(vCC,<0.0,0.0,0.5>,ZERO_ROTATION);}while(vCC){llLinkSitTarget(vCC,<0.0,0.0,0.5>,ZERO_ROTATION);--vCC;}vAJ=(integer)("0x"+llGetSubString((string)llGetKey(),0,7));llMessageLinked(LINK_SET,1,(string)vAJ,NULL_KEY);vAC=llGetNumberOfPrims();vAD=vAC;llListen(vAJ,"","","");vAK="";integer vCD=llGetInventoryNumber(INVENTORY_NOTECARD);while(vCC<vCD){vAK=llGetInventoryName(INVENTORY_NOTECARD,vCC);if(!(llSubStringIndex(vAK,"DEFAULT:")&&llSubStringIndex(vAK,"SET:"))){llMessageLinked(LINK_SET,200,vAK,NULL_KEY);return;}++vCC;}}link_message(integer vCE,integer vCF,string vCG,key vCZ){if(vCF==999999){llResetScript();}if(vCF==200){vAK=vCG;vAI=vCZ;vAE=vAA;vAA=0;llRegionSay(vAJ,"die");llRegionSay(vAJ,"adjuster_die");vAO=[];vBK=0;if(llGetInventoryKey(vAK)){vAH=llGetNotecardLine(vAK,vBK);}return;}if(vCF==207){vAN=vCG;vAI=vCZ;vAL=0;vAM=llGetNotecardLine(vAN,vAL);return;}if(vCF==201){vAO=[];vAF=TRUE;return;}if(vCF==205){vAO=[];vAF=FALSE;return;}if(vCF==300){list vCV=llParseString2List(vCG,["|"],[]);if(vCZ!=NULL_KEY){vCV=llListReplaceList((vCV=[])+vCV,[vCZ],2,2);}llRegionSay(vAJ,llDumpList2String(["LINKMSG",(string)llList2String(vCV,0),llList2String(vCV,1),(string)llList2String(vCV,2)],"|"));return;}if(vCF==202){if(llGetListLength(vAB)/8>=2){list vCJ=llParseString2List(vCG,[","],[]);SwapTwoSlots((integer)llList2String(vCJ,0),(integer)llList2String(vCJ,1));}return;}if(vCF==210){{integer vCK=(integer)llGetSubString(llList2String(vAB,llListFindList(vAB,[vCZ])+3),4,-1);if(vCK<=0){llWhisper(0,"avatar is not assigned a slot: "+(string)vCZ);}else{SwapTwoSlots(vCK,(integer)vCG);}}return;}if(vCF==(2035353)){list vCL=llParseStringKeepNulls(vCG,["^"],[]);integer vCM=llGetListLength(vCL)/8;integer vCN;for(vCN=0;vCN<vCM;++vCN){vAB=llListReplaceList(vAB,[llList2String(vCL,vCN*8),(vector)llList2String(vCL,vCN*8+1),(rotation)llList2String(vCL,vCN*8+2),llList2String(vCL,vCN*8+3),(key)llList2String(vCL,vCN*8+4),llList2String(vCL,vCN*8+5),llList2String(vCL,vCN*8+6),llList2String(vCL,vCN*8+7)],vCN*8,vCN*8+7);}return;}if(vCF==-999&&vCG=="RezHud"){if(llGetInventoryType("npose admin hud")!=INVENTORY_NONE){llRezObject("npose admin hud",llGetPos()+<0,0,1>,ZERO_VECTOR,llGetRot(),vAJ);}return;}if(vCF==-999&&vCG=="RemoveHud"){llRegionSayTo(vAP,vAJ,"/die");return;}if(vCF==34334){llSay(0,"Memory Used by "+llGetScriptName()+": "+(string)llGetUsedMemory()+" of "+(string)llGetMemoryLimit()+", Leaving "+(string)llGetFreeMemory()+" memory free.");return;}}object_rez(key vCZ){if(llKey2Name(vCZ)=="Adjuster"){vAO+=[vCZ];return;}if(llKey2Name(vCZ)=="npose admin hud"){vAP=vCZ;llSleep(2.0);llRegionSayTo(vAP,vAJ,"parent|"+(string)llGetKey());}}listen(integer vCP,string vCQ,key vCZ,string vCS){list vCT=llParseString2List(vCS,["|"],[]);if(vCQ=="Adjuster"){llMessageLinked(LINK_SET,3,vCS,vCZ);return;}if(!(llGetListLength(vCT)<2)){if(vCQ==llKey2Name(vAP)){list vCU=["adjust",201,"stopadjust",205,"posdump",204,"hudsync",206];integer $_=llListFindList(vCU,[vCS]);if(~$_){llMessageLinked(LINK_SET,llList2Integer(vCU,$_+1),"","");}}return;}integer $_0=(llGetSubString(vCS,0,4)=="ping");integer $_1=(llGetSubString(vCS,0,8)=="PROPRELAY");if(($_0||$_1)&&(llGetOwnerKey(vCZ)==llGetOwner())){if($_0){llRegionSay(vAJ,"pong|"+(string)vAQ+"|"+(string)llGetPos());return;}if($_1){list vCV=llParseString2List(vCS,["|"],[]);llMessageLinked(LINK_SET,llList2Integer(vCV,1),llList2String(vCV,2),llList2Key(vCV,3));return;}list vCW=llParseString2List(vCS,["|"],[]);vector vCX=(vector)llList2String(vCW,0)-llGetPos();vCX/=llGetRot();rotation vCY=llList2Rot(vCW,1)/llGetRot();string $_="\nPROP|"+vCQ+"|"+(string)vCX+"|"+(string)(llRot2Euler(vCY)*RAD_TO_DEG)+"|"+llList2String(vCW,2);llRegionSayTo(llGetOwner(),0,$_);llMessageLinked(LINK_SET,34333,$_,NULL_KEY);}}dataserver(key vCZ,string vDA){if(vCZ==vAH){if(vDA==EOF){assignSlots();if(vAF){vAO=[];llMessageLinked(LINK_SET,2,"RezAdjuster","");}}else{ProcessLine(vDA,vAI);vBK++;vAH=llGetNotecardLine(vAK,vBK);}return;}if((vCZ==vAM)&&(vDA!=EOF)){ProcessLine(vDA,vAI);vAL++;vAM=llGetNotecardLine(vAN,vAL);}}changed(integer vDB){if(vDB&CHANGED_LINK){llMessageLinked(LINK_SET,1,(string)vAJ,NULL_KEY);vAD=vAC;vAC=llGetNumberOfPrims();assignSlots();}if(vDB&CHANGED_INVENTORY){llResetScript();}if(vDB&CHANGED_REGION){llMessageLinked(LINK_SET,35353,llDumpList2String(vAB,"^"),NULL_KEY);}}on_rez(integer vDC){llResetScript();}}
